# Plan Execution System Requirements

## Overview

This document specifies the functional requirements for the Plan Execution System, which implements a Terraform-like plan/apply workflow for MongoDB cluster operations. The system generates immutable execution plans, persists them for review, and applies them with verification and checkpointing.

**System Name:** Plan Execution System
**Version:** 1.0
**Last Updated:** 2025-11-26
**Related Documents:**
- `docs/specs/PLAN_APPLY_SYSTEM.md` - Original design document
- `docs/DESIGN.md` - Overall architecture
- `pkg/plan/plan.go` - Core plan types

## System Definitions

**Plan:** An immutable, ordered sequence of PlannedOperations generated by simulation.

**PlannedOperation:** A single atomic operation with type, target, parameters, changes, and dependencies.

**Plan File:** A JSON-serialized representation of a Plan persisted to disk.

**Apply:** The process of executing a Plan's operations against real infrastructure.

**Checkpoint:** A persistent record of completed operations during Apply.

**Simulation Mode:** Execution using SimulationExecutor that records operations without side effects.

**Real Mode:** Execution using SSHExecutor or LocalExecutor with actual infrastructure changes.

---

## Requirements

### Plan Generation and Serialization

**REQ-PES-001:** Ubiquitous

**Requirement:**
The Plan Execution System shall generate a Plan by executing all deployment phases in simulation mode.

**Rationale:**
Simulation provides a safe preview of all operations without modifying infrastructure, matching Terraform's `terraform plan` behavior.

**Verification:**
Test that deploy/upgrade/import commands with `--dry-run` or simulation mode produce a Plan without creating directories, processes, or files.

---

**REQ-PES-002:** Event Driven

**Requirement:**
When plan generation completes, the Plan Execution System shall serialize the Plan to JSON format including all PlannedOperation fields (ID, Type, Description, Target, Params, Changes, Dependencies, Phase).

**Rationale:**
JSON serialization enables persistence, transmission, and language-agnostic parsing of plans. All PlannedOperation fields must be preserved for accurate execution.

**Verification:**
Test that the serialized JSON can be unmarshaled into PlannedOperation structs with all fields intact, including nested maps and slices.

---

**REQ-PES-003:** Ubiquitous

**Requirement:**
The Plan Execution System shall serialize PlannedOperation.Params as JSON objects preserving type information for strings, integers, booleans, and nested maps.

**Rationale:**
Operation handlers require correctly-typed parameters (e.g., supervisor_port as int, not string). JSON unmarshaling must preserve these types.

**Verification:**
Test that integer parameters like `supervisor_port: 19101` unmarshal as `int`, not `float64` or string.

---

**REQ-PES-004:** Event Driven

**Requirement:**
When generating a Plan, the Plan Execution System shall include metadata: plan_id (UUID), cluster_name, operation_type (deploy/upgrade/import), created_at (timestamp), and mup_version.

**Rationale:**
Metadata enables plan identification, version compatibility checks, and audit trails.

**Verification:**
Test that all generated plan files contain these metadata fields with valid values.

---

### Plan Persistence

**REQ-PES-005:** Event Driven

**Requirement:**
When a Plan is generated for cluster operations, the Plan Execution System shall persist the plan file to `~/.mup/storage/clusters/<cluster_name>/plans/<plan_id>.json`.

**Rationale:**
Per-cluster plan storage enables reviewing multiple plans and selecting which to apply, similar to Terraform's plan files.

**Verification:**
Test that `mup cluster deploy <name> --plan` creates a plan file at the expected path.

---

**REQ-PES-006:** Ubiquitous

**Requirement:**
The Plan Execution System shall store at most the 10 most recent plan files per cluster, deleting older plans automatically.

**Rationale:**
Prevents unbounded disk usage while retaining recent history for debugging and auditing.

**Verification:**
Test that generating 11 plans results in only 10 files remaining, with the oldest deleted.

---

**REQ-PES-007:** Event Driven

**Requirement:**
When persisting a plan file, the Plan Execution System shall set file permissions to 0600 (owner read/write only).

**Rationale:**
Plan files may contain sensitive information like paths, ports, and cluster topology. Restricting access prevents unauthorized viewing.

**Verification:**
Test that created plan files have mode 0600.

---

### Plan Verification

**REQ-PES-008:** Event Driven

**Requirement:**
When applying a plan, the Plan Execution System shall compute a SHA-256 hash of the plan file and verify it matches the hash presented during plan generation.

**Rationale:**
Prevents applying modified or corrupted plans. Users must review the exact plan they apply, matching Terraform's `-out` behavior.

**Verification:**
Test that modifying a plan file causes apply to fail with "plan file has been modified" error.

---

**REQ-PES-009:** Event Driven

**Requirement:**
When loading a plan file, the Plan Execution System shall verify the mup_version matches the current binary version (major.minor).

**Rationale:**
Plans generated with different mup versions may have incompatible operation types or parameters. Prevents applying stale plans.

**Verification:**
Test that applying a plan created with mup v0.1.0 using mup v0.2.0 fails with version mismatch error.

---

**REQ-PES-010:** Unwanted Behaviour

**Requirement:**
If a plan file cannot be parsed as valid JSON or is missing required metadata fields, then the Plan Execution System shall return an error "invalid plan file format" and abort.

**Rationale:**
Corrupted plan files must not be applied. Failing fast prevents undefined behavior.

**Verification:**
Test that applying a truncated or malformed JSON file returns the expected error.

---

### Plan Application

**REQ-PES-011:** Event Driven

**Requirement:**
When applying a plan, the Plan Execution System shall execute PlannedOperations in order by operation index, respecting Dependencies.

**Rationale:**
Operations have ordering constraints (e.g., create directory before uploading file). Dependencies ensure correct execution order.

**Verification:**
Test that operations execute in the order defined by the plan, and dependent operations wait for prerequisites.

---

**REQ-PES-012:** State Driven

**Requirement:**
While applying a plan, the Plan Execution System shall validate preconditions before executing each operation by calling the operation handler's Validate() method.

**Rationale:**
World state may change between plan generation and apply. Validation ensures each operation's preconditions still hold before execution.

**Verification:**
Test that if a directory created in a plan is manually deleted before apply, the validation fails and apply aborts.

---

**REQ-PES-013:** Event Driven

**Requirement:**
When an operation handler's Validate() method returns an error, the Plan Execution System shall log the validation failure and abort the apply with exit code 1.

**Rationale:**
Failed validations indicate plan assumptions no longer hold. Continuing would risk incorrect state or failures.

**Verification:**
Test that validation failures during apply stop execution and return non-zero exit code.

---

**REQ-PES-014:** Event Driven

**Requirement:**
When an operation handler's Execute() method returns an error, the Plan Execution System shall log the execution failure, save checkpoint, and abort the apply with exit code 1.

**Rationale:**
Execution failures must stop the apply to prevent cascading errors. Checkpoint allows resuming from failure point.

**Verification:**
Test that execution errors stop apply and create checkpoint file.

---

**REQ-PES-015:** Event Driven

**Requirement:**
When an operation executes successfully, the Plan Execution System shall record the operation result in the checkpoint file before proceeding to the next operation.

**Rationale:**
Incremental checkpointing enables resume on failure. Each completed operation is persisted immediately.

**Verification:**
Test that killing mup during apply leaves a checkpoint with all completed operations recorded.

---

**REQ-PES-016:** Optional Feature

**Requirement:**
Where the apply operation specifies `--resume`, the Plan Execution System shall load the checkpoint file and skip all operations marked as completed.

**Rationale:**
Resume capability prevents re-executing successful operations after failures, saving time and avoiding duplicate state changes.

**Verification:**
Test that `mup cluster apply <plan_id> --resume` skips completed operations and continues from failure point.

---

**REQ-PES-017:** Event Driven

**Requirement:**
When all operations complete successfully, the Plan Execution System shall delete the checkpoint file and mark the plan as applied.

**Rationale:**
Successful completion means no resume needed. Marking plan as applied prevents accidental re-application.

**Verification:**
Test that successful apply removes checkpoint and creates an `applied` marker file.

---

### Checkpointing

**REQ-PES-018:** Ubiquitous

**Requirement:**
The Plan Execution System shall persist checkpoint files to `~/.mup/storage/clusters/<cluster_name>/checkpoints/<plan_id>.json`.

**Rationale:**
Checkpoint files track apply progress and must be stored per-cluster and per-plan for accurate resume.

**Verification:**
Test that apply creates checkpoint file at expected path.

---

**REQ-PES-019:** Event Driven

**Requirement:**
When recording a checkpoint, the Plan Execution System shall include: plan_id, cluster_name, last_completed_operation_id, completed_operations (list of IDs), failed_operation_id (if any), error_message (if any), and updated_at timestamp.

**Rationale:**
Checkpoint must contain sufficient information to resume apply from exact failure point with context.

**Verification:**
Test that checkpoint JSON contains all specified fields with correct values.

---

**REQ-PES-020:** Event Driven

**Requirement:**
When resuming from checkpoint, the Plan Execution System shall verify the plan_id matches the requested plan and abort if mismatch occurs.

**Rationale:**
Prevents resuming with wrong plan, which would cause incorrect execution.

**Verification:**
Test that attempting to resume plan A with checkpoint from plan B returns error.

---

### Hook Integration

**REQ-PES-021:** Event Driven

**Requirement:**
When applying a plan, the Plan Execution System shall execute pre-operation hooks before each operation's Validate() call.

**Rationale:**
Hooks enable custom validation, safety checks, or preparation steps before operations execute.

**Verification:**
Test that pre-operation hooks execute before validation and can abort operation by returning error.

---

**REQ-PES-022:** Event Driven

**Requirement:**
When an operation completes, the Plan Execution System shall execute post-operation hooks after the operation's Execute() method returns success.

**Rationale:**
Post-hooks enable custom verification, logging, or cleanup after operations complete.

**Verification:**
Test that post-operation hooks execute after successful operation execution.

---

**REQ-PES-023:** Unwanted Behaviour

**Requirement:**
If a pre-operation hook returns an error, then the Plan Execution System shall abort the operation, record the hook failure in logs, and stop apply.

**Rationale:**
Hook failures indicate safety checks or preconditions failed. Continuing would be unsafe.

**Verification:**
Test that hook errors stop apply with descriptive error message.

---

### Output and Reporting

**REQ-PES-024:** Event Driven

**Requirement:**
When plan generation completes, the Plan Execution System shall display a human-readable summary showing: total operations, operations by type, operations by phase, and the plan file path.

**Rationale:**
Users need clear understanding of what the plan will do before applying it.

**Verification:**
Test that plan output includes operation count and breakdown.

---

**REQ-PES-025:** State Driven

**Requirement:**
While applying a plan, the Plan Execution System shall display progress showing: current operation number, total operations, operation description, and operation status (validating/executing/completed/failed).

**Rationale:**
Real-time progress feedback helps users understand apply status and estimate completion time.

**Verification:**
Test that apply output shows incremental progress for each operation.

---

**REQ-PES-026:** Event Driven

**Requirement:**
When simulation mode is enabled, the Plan Execution System shall output operation details in structured format including: operation index, type, target, details, and simulated changes.

**Rationale:**
Simulation output must be detailed enough to understand exactly what will happen during apply.

**Verification:**
Test that simulation output includes all specified fields in readable format.

---

**REQ-PES-027:** Optional Feature

**Requirement:**
Where the user specifies `--format=json`, the Plan Execution System shall output simulation results as JSON array of operation records.

**Rationale:**
Machine-readable output enables integration with CI/CD pipelines, testing frameworks, and automation tools.

**Verification:**
Test that `--format=json` produces valid JSON parseable by external tools.

---

### Error Handling and Recovery

**REQ-PES-028:** Unwanted Behaviour

**Requirement:**
If the cluster state changes during apply (detected via validation), then the Plan Execution System shall abort with error "cluster state diverged from plan".

**Rationale:**
State divergence means plan assumptions are invalid. Continuing would risk incorrect operations.

**Verification:**
Test that concurrent modifications to cluster cause apply to abort with clear error.

---

**REQ-PES-029:** Unwanted Behaviour

**Requirement:**
If a plan file is not found at the specified path, then the Plan Execution System shall return error "plan file not found: <path>" with exit code 1.

**Rationale:**
Missing plan files indicate incorrect path or deleted plans. Failing fast prevents confusion.

**Verification:**
Test that applying non-existent plan returns expected error.

---

**REQ-PES-030:** Event Driven

**Requirement:**
When apply fails, the Plan Execution System shall display: failed operation description, error message, operations completed count, and resume command.

**Rationale:**
Clear failure output helps users understand what went wrong and how to recover.

**Verification:**
Test that apply failures show all specified information.

---

### Idempotency and Safety

**REQ-PES-031:** Unwanted Behaviour

**Requirement:**
If a user attempts to apply the same plan twice, then the Plan Execution System shall detect the applied marker and return error "plan already applied".

**Rationale:**
Prevents accidental re-application which could cause duplicate operations or errors.

**Verification:**
Test that applying same plan twice without --force flag returns error.

---

**REQ-PES-032:** Optional Feature

**Requirement:**
Where the user specifies `--force`, the Plan Execution System shall allow re-applying an already-applied plan.

**Rationale:**
Force flag enables intentional re-application for repair scenarios, but requires explicit opt-in.

**Verification:**
Test that `mup cluster apply <plan_id> --force` bypasses applied marker check.

---

**REQ-PES-033:** State Driven

**Requirement:**
While executing operations, the Plan Execution System shall ensure each operation handler implements idempotent behavior (executing twice produces same result as executing once).

**Rationale:**
Idempotency enables safe retries and resume. Operations must not fail or cause errors if already completed.

**Verification:**
Test that resuming apply after failure and re-executing completed operations succeeds without errors.

---

### Cluster Locking and Concurrency

**REQ-PES-039:** Event Driven

**Requirement:**
When applying a plan, the Plan Execution System shall acquire an exclusive cluster lock before executing operations.

**Rationale:**
Prevents multiple concurrent applies to the same cluster which would cause state corruption.

**Verification:**
Test that attempting to apply two plans to same cluster concurrently fails with lock error.

---

**REQ-PES-040:** Event Driven

**Requirement:**
When apply completes or fails, the Plan Execution System shall release the cluster lock.

**Rationale:**
Ensures lock is cleaned up so future operations can proceed.

**Verification:**
Test that lock file is removed after apply completes successfully or with error.

---

**REQ-PES-041:** Unwanted Behaviour

**Requirement:**
If a cluster lock exists but the process that created it is no longer running or the lock has expired, then the Plan Execution System shall remove the stale lock and proceed.

**Rationale:**
Stale locks from crashed processes or expired timeouts must not block future operations.

**Verification:**
Test that locks from killed processes or with expired timestamps are automatically removed.

---

**REQ-PES-049:** Ubiquitous

**Requirement:**
The Plan Execution System shall include expiration timestamp (expires_at) and timeout duration (lock_timeout) in cluster lock files.

**Rationale:**
Enables timeout-based staleness detection independent of process checks. Useful across system reboots.

**Verification:**
Test that lock files contain expires_at and lock_timeout fields with valid values.

---

**REQ-PES-050:** Ubiquitous

**Requirement:**
The Plan Execution System shall set cluster lock timeout to 24 hours by default.

**Rationale:**
Most operations complete within 24h. Long enough to avoid premature expiry, short enough to clean up abandoned locks.

**Verification:**
Test that newly created locks expire 24 hours after creation.

---

**REQ-PES-051:** Event Driven

**Requirement:**
When a plan applies operations, the Plan Execution System shall allow the same plan to renew its own lock by extending the expiration timestamp.

**Rationale:**
Long-running operations need to keep lock active. Only same plan can renew to prevent hijacking.

**Verification:**
Test that lock renewal succeeds for same plan ID and fails for different plan ID.

---

**REQ-PES-052:** State Driven

**Requirement:**
While applying a plan, the Plan Execution System shall renew the cluster lock every 1 hour by extending expiration by 24 hours.

**Rationale:**
Prevents lock expiration during lengthy operations while maintaining reasonable timeout for abandoned locks.

**Verification:**
Test that lock expires_at is extended during long-running apply operations.

---

**REQ-PES-053:** Ubiquitous

**Requirement:**
The Plan Execution System shall provide CLI commands to view lock status (`mup cluster lock status`), clear locks (`mup cluster lock clear`), and list all locks (`mup cluster lock list`).

**Rationale:**
Users need visibility into locks and ability to manually clear stuck locks.

**Verification:**
Test that CLI commands show accurate lock information and can clear locks.

---

**REQ-PES-054:** Event Driven

**Requirement:**
When resuming a failed plan, the Plan Execution System shall renew the existing lock if the plan ID matches, otherwise acquire a new lock.

**Rationale:**
Resume should be able to continue using the same lock from the failed attempt if it's the same plan.

**Verification:**
Test that resume with same plan ID successfully renews lock and continues.

---

## Requirements Traceability

| Requirement ID | Implementation File | Test File |
|---------------|-------------------|-----------|
| REQ-PES-001 | `pkg/apply/applier.go` | TBD |
| REQ-PES-002 | `pkg/plan/plan.go` | TBD |
| REQ-PES-003 | `pkg/plan/plan.go` | TBD |
| REQ-PES-004 | `pkg/plan/plan.go` | TBD |
| REQ-PES-005 | `pkg/apply/applier.go` | TBD |
| REQ-PES-011 | `pkg/apply/applier.go` | TBD |
| REQ-PES-012 | `pkg/apply/applier.go` | `pkg/apply/applier_test.go` |
| REQ-PES-015 | `pkg/apply/checkpoint.go` | TBD |
| REQ-PES-021 | `pkg/apply/hooks.go` | TBD |
| REQ-PES-024 | `cmd/mup/cluster.go` | TBD |

## Appendix A: Plan File Format

### Example Plan File Structure

```json
{
  "metadata": {
    "plan_id": "4c243baf-fde1-4440-b9d6-4cd6093978be",
    "cluster_name": "test-rs",
    "operation_type": "deploy",
    "created_at": "2025-11-26T10:30:00Z",
    "mup_version": "0.1.0",
    "sha256": "a3b2c1d4e5f6..."
  },
  "operations": [
    {
      "id": "deploy-001",
      "type": "create_directory",
      "description": "Create cluster base directory",
      "target": {
        "type": "filesystem",
        "name": "/Users/zph/.mup/storage/clusters/test-rs/v7.0"
      },
      "params": {
        "path": "/Users/zph/.mup/storage/clusters/test-rs/v7.0",
        "mode": 493
      },
      "changes": {
        "action": "create",
        "resource_type": "directory",
        "resource_id": "/Users/zph/.mup/storage/clusters/test-rs/v7.0"
      },
      "dependencies": [],
      "phase": "prepare"
    },
    {
      "id": "deploy-027",
      "type": "execute",
      "description": "Start supervisord daemon for cluster test-rs (port: 19101)",
      "target": {
        "type": "supervisor",
        "name": "supervisord"
      },
      "params": {
        "cluster_dir": "/Users/zph/.mup/storage/clusters/test-rs/v7.0",
        "cluster_name": "test-rs"
      },
      "changes": {
        "action": "create",
        "resource_type": "process",
        "resource_id": "supervisord:19101"
      },
      "dependencies": ["deploy-026"],
      "phase": "deploy"
    }
  ],
  "summary": {
    "total_operations": 50,
    "operations_by_type": {
      "create_directory": 10,
      "upload_file": 5,
      "generate_config": 8,
      "start_process": 15,
      "mongo_execute": 12
    },
    "operations_by_phase": {
      "prepare": 25,
      "deploy": 15,
      "initialize": 8,
      "finalize": 2
    }
  }
}
```

### Example Checkpoint File Structure

```json
{
  "plan_id": "4c243baf-fde1-4440-b9d6-4cd6093978be",
  "cluster_name": "test-rs",
  "started_at": "2025-11-26T10:35:00Z",
  "updated_at": "2025-11-26T10:35:45Z",
  "status": "failed",
  "last_completed_operation_id": "deploy-026",
  "completed_operations": [
    "deploy-001",
    "deploy-002",
    "...",
    "deploy-026"
  ],
  "failed_operation_id": "deploy-027",
  "error_message": "failed to start supervisord: exec: no such file or directory",
  "operations_completed": 26,
  "operations_total": 50
}
```

## Appendix B: CLI Commands

### Generate Plan

```bash
# Generate and save plan without applying
mup cluster deploy test-rs --plan

# Output:
# Plan generated: /Users/zph/.mup/storage/clusters/test-rs/plans/4c243baf-fde1-4440-b9d6-4cd6093978be.json
# Total operations: 50
# - prepare: 25
# - deploy: 15
# - initialize: 8
# - finalize: 2
#
# To apply: mup cluster apply test-rs --plan-id=4c243baf-fde1-4440-b9d6-4cd6093978be
```

### View Plan

```bash
# Show plan details
mup cluster plan test-rs --plan-id=4c243baf

# Show plan as JSON
mup cluster plan test-rs --plan-id=4c243baf --format=json
```

### Apply Plan

```bash
# Apply specific plan
mup cluster apply test-rs --plan-id=4c243baf

# Resume from checkpoint
mup cluster apply test-rs --plan-id=4c243baf --resume

# Force re-apply
mup cluster apply test-rs --plan-id=4c243baf --force
```

### List Plans

```bash
# List all plans for cluster
mup cluster plans test-rs

# Output:
# PLAN ID    CREATED              STATUS    OPERATIONS
# 4c243baf   2025-11-26 10:30:00  applied   50
# 8a9b1c2d   2025-11-25 14:20:00  failed    50 (26 completed)
# 3f4e5d6c   2025-11-24 09:15:00  pending   45
```

## Appendix C: Implementation Notes

### Phase 1: Basic Plan Persistence
- Implement plan JSON serialization in `pkg/plan/plan.go`
- Add `SavePlan()` and `LoadPlan()` functions
- Update deploy command to save plans
- Tags: REQ-PES-001, REQ-PES-002, REQ-PES-005

### Phase 2: Plan Verification
- Implement SHA-256 hash verification
- Add version compatibility checks
- Tags: REQ-PES-008, REQ-PES-009, REQ-PES-010

### Phase 3: Apply Command
- Create `mup cluster apply` command
- Implement operation execution loop with validation
- Tags: REQ-PES-011, REQ-PES-012, REQ-PES-013, REQ-PES-014

### Phase 4: Checkpointing
- Implement checkpoint save/load in `pkg/apply/checkpoint.go`
- Add --resume flag support
- Tags: REQ-PES-015, REQ-PES-016, REQ-PES-018, REQ-PES-019, REQ-PES-020

### Phase 5: Enhanced Output
- Add progress indicators
- Implement --format=json
- Tags: REQ-PES-024, REQ-PES-025, REQ-PES-026, REQ-PES-027
